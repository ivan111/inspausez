(function(){function h(){z.labels=z.createLabels();z.history=z.createHistory(z.labels);d3.select("#normal-mode-tab").style("pointer-events","none");d3.select("#download-audio-link").on("click",function(){var b=z.createWavBlob();this.href=(window.URL||window.webkitURL).createObjectURL(b)});d3.select("#download-info-link").on("click",function(){var b=new window.Blob([z.labels.toString()],{type:"text/plain"});this.href=(window.URL||window.webkitURL).createObjectURL(b)});d3.select("#search-mode-button").on("click",
function(){n("#search-mode-tab",!0);n("#normal-mode-tab",!1);z.labelsSearch=null;z.isSearchMode=!0;z.viz.updateLabels()});g();l();z.file.init();z.viz.init();z.initSearchPanel();z.toolbar.init();z.player.onChange=a;e();d();z.toolbar.setEnable()}function e(){d3.select("#volume").on("input",function(){z.player.changeVolume(this)}).on("change",function(){z.player.changeVolume(this)})}function d(){d3.select("body").on("keydown",function(){var b=d3.event.keyCode;107===b?z.viz.zoomIn():109===b&&z.viz.zoomOut()})}
function c(a){z.buffer=a;z.vol=z.calcVolume(a);z.len=z.vol.length;z.durS=a.duration;z.curS=0;z.offsetTime=0;z.viz.setVolume();d3.select("#current-pos").style("visibility","visible");d3.select("#normal-mode-tab").style("pointer-events","auto");b(z.findSound(z.vol))}function b(b){z.labels=b;z.history=z.createHistory(b);z.labelsSearch=null;z.viz.updateLabels();z.toolbar.setEnable()}function a(){z.isAudioPlaying&&(z.curS=z.offsetTime+z.context.currentTime-z.startTime);z.viz.updateCurrentPos(!0)}function g(){var b=
d3.select("#factor-text");d3.select("#factor").on("input",function(){z.factor=parseInt(this.value)/100;b.text(z.factor.toFixed(2))}).on("change",function(){z.factor=parseInt(this.value)/100;b.text(z.factor.toFixed(2))})}function l(){var b=d3.select("#add-text");d3.select("#add").on("input",function(){z.addS=parseInt(this.value)/100;b.text(z.addS.toFixed(1))}).on("change",function(){z.addS=parseInt(this.value)/100;b.text(z.addS.toFixed(1))})}function n(b,a){var g=d3.select(b);a?g.style("display","block"):
g.style("display","none")}window.z={WIDTH:960,HEIGHT:500,INSERT_DUR_S:.5,MIN_DUR_S:.1,run:function(){z.context=z.audio.getContext();z.context?(h(),z.audio.load(z.context,"jfk.mp3",c)):window.alert("\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u30d6\u30e9\u30a6\u30b6\u3067\u3059\u3002Chrome \u304b Firefox \u3067\u8a66\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002")},head:function(){z.isPlaying&&z.player.pause();z.curS=0;z.offsetTime=0;z.viz.updateCurrentPos(!0);z.toolbar.setEnable()},
canHead:function(){return 0!==z.curS&&!z.isPlaying&&!z.isAudioPlaying},onLoadAudio:c,calcPauseS:function(b){return b*z.factor+z.addS},canUndo:function(){return!z.isSearchMode&&z.history&&z.history.canUndo()?!0:!1},undo:function(){z.history&&z.history.canUndo()&&(z.labels=z.history.undo(),z.viz.updateLabels())},canRedo:function(){return!z.isSearchMode&&z.history&&z.history.canRedo()?!0:!1},redo:function(){z.history&&z.history.canRedo()&&(z.labels=z.history.redo(),z.viz.updateLabels())},setLabels:b,
setDivVisibility:n,context:null,source:null,isPlaying:!1,isAudioPlaying:!1,startTime:0,offsetTime:0,buffer:null,timerId:null,vol:null,len:0,durS:0,curS:0,factor:1,addS:.2,curGain:1,labels:null,history:null,labelsSearch:null,isSearchMode:!1,curLabelI:0,SIL_LV:5,SIL_DUR_S:.3,SND_DUR_S:.2,BEFORE_DUR_S:.2,AFTER_DUR_S:.2};z.silLv=z.SIL_LV;z.silDurS=z.SIL_DUR_S;z.sndDurS=z.SND_DUR_S;z.beforeDurS=z.BEFORE_DUR_S;z.afterDurS=z.AFTER_DUR_S})();(function(){function h(){e();for(var a=this.files||d3.event.dataTransfer.files,g=0;g<a.length;g++){var c=a[g];if(b.exec(c.name)){if(window.FileReader){var d=new window.FileReader;d.readAsText(c);d.onload=function(b){b=b.target.result;var a=z.createLabels();a.loadFromStr(b,z.durS);0<a.length&&z.setLabels(a)}}}else z.audio.load(z.context,URL.createObjectURL(c),z.onLoadAudio)}}function e(){d3.event.stopPropagation();d3.event.preventDefault();c.className="dragover"===d3.event.type?"hover":""}z.file={init:function(){if(!(window.File&&
window.FileList&&window.FileReader))return!1;d=d3.select("#file-select");c=d3.select("#viz");d.on("change",h);c.on("dragover",e);c.on("dragleave",e);c.on("drop",h)}};var d,c,b=/.*\.txt$/i})();(function(){z.audio={getContext:function(){var h=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,e=null;h&&(e=new h);return e},load:function(h,e,d){var c=new XMLHttpRequest;c.open("GET",e,!0);c.responseType="arraybuffer";c.onload=function(){h.decodeAudioData(c.response,function(b){d(b)},function(){window.alert("error")})};c.send()}}})();(function(){function h(e,d,c){for(var b=c.length,a=0;a<b;a++)e.setUint8(d+a,c.charCodeAt(a))}z.createWavBlob=function(){if(!z.buffer)return null;for(var e=z.buffer,d=e.length,c=e.sampleRate,b=e.numberOfChannels,a=0;a<z.labels.length;a++){var g=z.labels[a];g.isPause()&&(d+=Math.floor(z.calcPauseS(g.durS())*c))}for(var l=z.context.createBuffer(b,d,c),n=0;n<b;n++){for(var k=e.getChannelData(n),q=0,p=l.getChannelData(n),t=0,a=0;a<z.labels.length;a++)if(g=z.labels[a],g.isPause()){for(var r=Math.floor(g.endS()*
c)-q,G=p,H=t,I=k,x=q,u=r;0<=--u;)G[H++]=I[x++];t+=r;q+=r;r=Math.floor(z.calcPauseS(g.durS())*c);g=p;G=t;for(H=r;0<=--H;)g[G++]=0;t+=r}if(t<d)for(r=d-q,a=p;0<=--r;)a[t++]=k[q++]}e=l.sampleRate;d=l.numberOfChannels;if(1===d)l=l.getChannelData(0);else{c=l.getChannelData(0);l=l.getChannelData(1);b=new Float32Array(2*c.length);for(r=n=0;r<c.length;r++)b[n++]=c[r],b[n++]=l[r];l=b}b=2*l.length;c=new ArrayBuffer(44+2*l.length);c=new DataView(c);h(c,0,"RIFF");c.setUint32(4,44+b,!0);h(c,8,"WAVE");h(c,12,"fmt ");
c.setUint32(16,16,!0);c.setUint16(20,1,!0);c.setUint16(22,d,!0);c.setUint32(24,e,!0);c.setUint32(28,2*e*d,!0);c.setUint16(32,2*d,!0);c.setUint16(34,16,!0);h(c,36,"data");c.setUint32(40,b,!0);e=44;for(d=0;d<l.length;d++)c.setInt16(e,32767*l[d],!0),e+=2;return new window.Blob([c],{type:"audio/wav"})}})();(function(){function h(e,d,c){for(var b=0,a=d;a<c;a++)b+=e[a]*e[a];return Math.sqrt(b/(c-d))}z.VOL_RATE=768;z.calcVolume=function(e){for(var d=e.getChannelData(0),c=e.sampleRate,b=Math.floor(e.length*z.VOL_RATE/c),a=[],g=0,l=0;l<b;l++){var n=Math.floor((l+1)*c/z.VOL_RATE),n=Math.min(n,e.length);a.push(h(d,g,n));g=n}return a};z.getSubVolume=function(e,d,c){var b=Math.floor(e*z.VOL_RATE),b=b&~(d-1);if(1===d)e=z.vol.slice(b,b+c);else{e=[];for(var a=0;a<c;a++)b<z.vol.length?e.push(z.vol[b]):e.push(0),
b+=d}return e}})();(function(){z.createHistory=function(e){function d(){}var c=[e.clone()],b=0;d.toString=function(){return["history: length = ",c.length,", current index = ",b].join("")};d.save=function(a){b+1<c.length&&(c.length=b+1);c.push(a.clone());b++;c.length>h&&(c.shift(),b--);return d};d.canUndo=function(){return 0!==b};d.undo=function(){return d.canUndo()?c[--b].clone():null};d.canRedo=function(){return b!==c.length-1};d.redo=function(){return d.canRedo()?c[++b].clone():null};return d};var h=100})();(function(){function h(c,b,a){function g(){}var l=null;(function(a,g){g=Math.max(0,g);c=a=Math.max(0,Math.min(a,g));b=g})(c,b);a!==d&&(a=e);g.toString=function(){return[c.toFixed(6),b.toFixed(6),a].join("\t")};g.clone=function(){return h(c,b,a)};g.startS=function(a){if(!arguments.length)return c;c=Math.max(0,Math.min(a,b-z.MIN_DUR_S));l=null;return g};g.endS=function(a){if(!arguments.length)return b;b=Math.max(c+z.MIN_DUR_S,a);l=null;return g};g.durS=function(){return b-c};g.colour=function(){if(!l){var b=
60*g.durS()+380;if(780<b)l=[255,0,0];else{var a=Math.floor(b),c,d;380<=a&&440>a?(b=-(a-440)/90,c=0,d=1):440<=a&&490>a?(b=0,c=(a-440)/50,d=1):490<=a&&510>a?(b=0,c=1,d=-(a-510)/20):(510<=a&&580>a?(b=(a-510)/70,c=1):580<=a&&645>a?(b=1,c=-(a-645)/65):(b=645<=a&&780>=a?1:0,c=0),d=0);a=255*(380<=a&&420>a?.3+.7*(a-350)/70:420<=a&&700>=a?1:700<a&&780>=a?.3+.7*(780-a)/80:0);l=[Math.floor(a*b),Math.floor(a*c),Math.floor(a*d)]}}return l};g.isPause=function(){return a===e};g.isCut=function(){return a===d};g.setPause=
function(){a=e};g.setCut=function(){a=d};g.contains=function(a){return c<=a&&a<=b?!0:!1};return g}z.createPauseLabel=function(c,b){return h(c,b,e)};z.createEraseLabel=function(c,b){return h(c,b,d)};var e="p",d="x"})();(function(){function h(){}function e(c){var b=new h;b.toString=function(){for(var a=[],g=0;g<b.length;g++)a.push(b[g].toString());return a.join("\n")};b.clone=function(){for(var a=e(),g=0;g<b.length;g++)a.push(b[g].clone());return a};b.canInsertLabel=function(a,g,c){return b.getInsertableRange(a,g,c)?!0:!1};b.insertLabel=function(a,g,c){if(c=b.getInsertableRange(a,g,c))a-c[0]<g/2?(a=c[0],c=a+g):c[1]-a<g/2?(c=c[1],a=c-g):(a-=g/2,c=a+g),g=z.createPauseLabel(a,c),b.sortedAdd(g)};b.canCut=function(a){for(var c=
0;c<b.length;c++){var d=b[c];if(d.contains(a)&&!(a<d.startS()+.1||d.endS()-.1<a))return!0}return!1};b.cut=function(a){for(var c=0;c<b.length;c++){var d=b[c];if(d.contains(a)){var e=z.createPauseLabel(a,d.endS());d.endS(a);b.splice(c+1,0,e);break}}return b};b.getPrev=function(a){a=b.indexOf(a);return 0>=a?null:b[a-1]};b.getNext=function(a){a=b.indexOf(a);return-1===a||a===b.length-1?null:b[a+1]};b.remove=function(a){a=b.indexOf(a);-1!==a&&b.splice(a,1)};b.canLeftMerge=function(a){return b.getPrev(a)?
!0:!1};b.leftMerge=function(a){var c=b.getPrev(a);c&&(a.startS(c.startS()),b.remove(c))};b.canRightMerge=function(a){return b.getNext(a)?!0:!1};b.rightMerge=function(a){var c=b.getNext(a);c&&(a.endS(c.endS()),b.remove(c))};b.sortedAdd=function(a){for(var c=0;c<b.length;c++)if(b[c].endS()>a.endS()){b.splice(c,0,a);return}b.push(a)};b.getInsertableRange=function(a,c,d){if(0>a||d<a||0>=c||d<c)return null;d=[0,d];for(var e=0;e<b.length;e++){var k=b[e];if(k.contains(a))return null;k.endS()<a&&(d[0]=k.endS());
if(a<k.startS()){d[1]=k.startS();break}}return c<=d[1]-d[0]?d:null};b.loadFromStr=function(a,c){for(var e=a.split("\n"),h=0;h<e.length;h++){var k=d.exec(e[h]);try{var q=parseFloat(k[1]),p=parseFloat(k[3]),t=k[5];0>q||q>c||q>=p||"p"!==t||(p>c&&(p=c),p-q<z.MIN_DUR_S||b.sortedAdd(z.createPauseLabel(q,p)))}catch(r){}}};return b}z.createLabels=e;var d=/^(\d+(\.\d{0,6})?)\s+(\d+(\.\d{0,6})?)\s+(.*)/;h.prototype=Object.create(Array.prototype)})();(function(){z.findSound=function(h,e,d,c,b,a){e="undefined"!==typeof e?e:z.SIL_LV;d="undefined"!==typeof d?d:z.SIL_DUR_S;c="undefined"!==typeof c?c:z.SND_DUR_S;b="undefined"!==typeof b?b:z.BEFORE_DUR_S;a="undefined"!==typeof a?a:z.AFTER_DUR_S;var g=h.length/z.VOL_RATE;e=Math.max(0,Math.min(e,100));var l=Math.max.apply(null,h);e=e*l/100;var n=d*z.VOL_RATE;c*=z.VOL_RATE;var k=0,q=0,p=-1;d=-1;for(var t=!0,l=z.createLabels(),r=0;r<h.length;r++)if(h[r]<=e)if(k++,-1===p)p=r;else{if(!t&&-1!==d&&k>n&&q>c){n=
p+Math.floor(a*z.VOL_RATE);h.length<n&&(n=h.length);k=0;for(q=p;q<n;q++)if(h[q]<=e)k++;else break;n=k;k=d/z.VOL_RATE-b;k=Math.max(0,Math.min(k,g));p=(p+n)/z.VOL_RATE;p=Math.max(0,Math.min(p,g));l.push(z.createPauseLabel(k,p));t=!0;q=k=0;p=-1}}else q++,t&&(t=!1,d=r),k=0,p=-1;t||(k=d/z.VOL_RATE-b,k=Math.max(0,Math.min(k,g)),p=p/z.VOL_RATE+a,p=Math.max(0,Math.min(p,g)),p<k&&(p=g),l.push(z.createPauseLabel(k,p)));return l}})();(function(){function h(){return!z.isPlaying&&!z.isAudioPlaying}function e(a,c){h()&&(arguments.length?(k=a,q=c):(k=[{type:b,startS:0,endS:z.durS}],q=0,t=!0),d(!0))}function d(d){z.isPlaying=!0;var e=k[q];if(e.type===b){var g=e.startS,h=e.endS-e.startS;d&&e.type===b&&z.curS!==e.startS&&(g=z.curS,h-=z.curS-e.startS);d=z.offsetTime=g;z.source=z.context.createBufferSource();z.source.buffer=z.buffer;z.source.onended=c;z.gainNode=z.context.createGain();z.gainNode.gain.value=z.curGain;z.source.connect(z.gainNode);
z.gainNode.connect(z.context.destination);z.source.start(0,d,h);z.startTime=z.context.currentTime;z.isAudioPlaying=!0;p=setInterval(z.player.onChange,20)}else e.type===a?setTimeout(c,Math.floor(1E3*e.durS)):(z.isPlaying=!1,z.curS=e.curS,z.player.onChange(),z.toolbar.setEnable())}function c(){z.isAudioPlaying&&(z.isAudioPlaying=!1,clearInterval(p));z.gainNode=null;if(r)r=!1;else{var a=k[q];a&&a.type===b&&(z.curS=a.endS,z.player.onChange())}z.isPlaying?(q++,q<k.length?d():t?(q=0,z.curS=0,d()):(z.isPlaying=
!1,z.toolbar.setEnable())):z.toolbar.setEnable()}z.player={canPlay:h,play:e,playPause:function(){if(h()){var c=[],d=0,g;g=z.isSearchMode?z.labelsSearch:z.labels;for(var k=0;k<g.length;k++){var l=g[k];l.isPause()&&(c.push({type:b,startS:d,endS:l.endS()}),d=l.endS(),c.push({type:a,durS:z.calcPauseS(l.durS())}))}d<z.durS&&c.push({type:b,durS:z.durS-d});a:{for(d=0;d<c.length;d++)if(g=c[d],g.type===b&&g.startS<=z.curS&&z.curS<g.endS)break a;d=0}t=!0;e(c,d)}},playLabel:function(a){if(h()){var c=[{type:b,
startS:a.startS(),endS:a.endS()}];z.curS=a.startS();t=!1;e(c,0);z.toolbar.setEnable()}},playIfCut:function(){if(h()){var c=[];c.push({type:b,startS:Math.max(0,z.curS-l),endS:z.curS});c.push({type:a,durS:n});c.push({type:b,startS:z.curS,endS:Math.min(z.curS+l,z.durS)});c.push({type:g,curS:z.curS});z.curS=c[0].startS;t=!1;e(c,0);z.toolbar.setEnable()}},canPause:function(){return z.isPlaying||z.isAudioPlaying},pause:function(){z.isPlaying=!1;r=!0;z.isAudioPlaying&&(z.source.stop(),z.curS=z.offsetTime+
z.context.currentTime-z.startTime,z.player.onChange());z.toolbar.setEnable()},changeVolume:function(a){a=parseInt(a.value)/parseInt(a.max);z.curGain=a*a;z.gainNode&&(z.gainNode.gain.value=z.curGain)},onChange:null};var b=1,a=2,g=3,l=.8,n=.5,k=[],q,p,t=!1,r=!1})();(function(){z.viewport=function(e,d,c){function b(){}var a=0,g=4,l=null,n=e*g/d;b.startS=function(k){if(!arguments.length)return a;var h=a;a=Math.max(0,Math.min(k,n-e*g/d));l=null;h!==a&&c();return b};b.scale=function(){return g};b.endS=function(){l||(l=Math.min(a+e*g/d,n));return l};b.maxEndS=function(a){if(!arguments.length)return n;n=a;l=null;return b};b.durS=function(){return b.endS()-a};b.isVisible=function(c,d){var e=b.endS();return 1===arguments.length?a<=c&&c<=e:d<a||c>e?!1:a<=c&&c<=e||a<=
d&&d<=e||c<=a&&a<=d&&c<=e&&e<=d?!0:!1};b.range=function(){return[a,b.endS()]};b.canZoomIn=function(){return 1!==g};b.zoomIn=function(){b.canZoomIn()&&(g/=2,l=null,c())};b.canZoomOut=function(){return g<=h};b.zoomOut=function(){b.canZoomOut()&&(g*=2,l=null,c())};b.sec2x=function(b){return Math.floor((b-a)*d/g)};b.sec2width=function(a){return Math.floor(a*d/g)};b.x2sec=function(b){return a+b*g/d};b.width2sec=function(a){return a*g/d};b.sec2ax=function(a){return Math.floor(a*e/n)};b.ax2sec=function(a){return a*
n/e};return b};var h=8})();(function(){function h(){f.insertHandleLayer=d3.select("#insert-handle-layer");f.insertHandle=d3.select("#insert-handle").on("click",function(){z.isSearchMode||z.isPlaying||(z.labels.insertLabel(z.curS,z.INSERT_DUR_S,z.durS),z.history.save(z.labels),f.insertHandleLayer.style("visibility","hidden"),k(),z.toolbar.setEnable())}).on("mouseover",A).on("mouseout",B);f.insertIcon=d3.select("#insert-icon")}function e(){f.cutHandleLayer=d3.select("#cut-handle-layer").on("mouseout",C);f.cutHandle=d3.select("#cut-handle").on("click",
function(){z.isSearchMode||z.isPlaying||(z.labels.cut(z.curS),z.history.save(z.labels),k(),z.toolbar.setEnable())}).on("mouseover",A).on("mouseout",B);f.cutIcon=d3.select("#cut-icon")}function d(){f.play1HandleLayer=d3.select("#play1-handle-layer").on("mouseout",C);f.play1Handle=d3.select("#play1-handle").on("click",function(a){z.player.playLabel(a);k()}).on("mouseover",A).on("mouseout",B);f.play1Icon=d3.select("#play1-icon")}function c(){f.play2HandleLayer=d3.select("#play2-handle-layer").on("mouseout",
C);f.play2Handle=d3.select("#play2-handle").on("click",function(){z.player.playIfCut();k()}).on("mouseover",A).on("mouseout",B);f.play2Icon=d3.select("#play2-icon")}function b(){f.play3HandleLayer=d3.select("#play3-handle-layer").on("mouseout",C);f.play3Handle=d3.select("#play3-handle").on("click",function(a){z.curS=a.endS();z.player.playIfCut();k()}).on("mouseover",A).on("mouseout",B);f.play3Icon=d3.select("#play3-icon")}function a(){f.removeHandleLayer=d3.select("#remove-handle-layer").on("mouseout",
C);f.removeHandle=d3.select("#remove-handle").on("click",function(a){z.isSearchMode||z.isPlaying||(z.labels.remove(a),z.history.save(z.labels),k(),E(),z.toolbar.setEnable())}).on("mouseover",A).on("mouseout",B);f.removeIcon=d3.select("#remove-icon")}function g(){f.lmergeHandleLayer=d3.select("#lmerge-handle-layer").on("mouseout",C);f.lmergeHandle=d3.select("#lmerge-handle").on("click",function(a){z.isSearchMode||z.isPlaying||(z.labels.leftMerge(a),z.history.save(z.labels),k(),E(),z.toolbar.setEnable())}).on("mouseover",
A).on("mouseout",B);f.lmergeIcon=d3.select("#lmerge-icon")}function l(){f.rmergeHandleLayer=d3.select("#rmerge-handle-layer").on("mouseout",C);f.rmergeHandle=d3.select("#rmerge-handle").on("click",function(a){z.isSearchMode||z.isPlaying||(z.labels.rightMerge(a),z.history.save(z.labels),k(),E(),z.toolbar.setEnable())}).on("mouseover",A).on("mouseout",B);f.rmergeIcon=d3.select("#rmerge-icon")}function n(){var a=d3.scale.linear().range([w,0]).domain([0,Math.max.apply(null,z.vol)]),b=d3.svg.area().x(function(a,
b){return b}).y0(w).y1(function(b){return a(b)}),c=z.getSubVolume(m.startS(),m.scale(),y);f.focusVolume.datum(c).attr("d",b);b=d3.scale.linear().range([0,y]).domain(m.range());b=d3.svg.axis().scale(b).orient("bottom");f.focusAxis.call(b)}function k(){var a;f.labelsLayer.html("");if(z.isSearchMode){z.labelsSearch||(z.labelsSearch=z.findSound(z.vol,z.silLv,z.silDurS,z.sndDurS,z.beforeDurS,z.afterDurS));a=O(z.labelsSearch);f.labelsRects=f.labelsLayer.selectAll("rect").data(a);a=f.labelsRects.enter().append("g").call(N).on("click",
r);var b=m.sec2width(z.beforeDurS),c=Math.floor(w/3);a.append("rect").attr("class","before-label").attr("x",function(a){return m.sec2x(a.startS())}).attr("y",0).attr("width",b).attr("height",c);b=m.sec2width(z.afterDurS);a.append("rect").attr("class","after-label").attr("x",function(a){return m.sec2x(a.startS())+m.sec2width(a.durS())-b}).attr("y",Math.floor(2*w/3)).attr("width",b).attr("height",c);a.append("rect").attr("class","search-label").attr("x",function(a){return m.sec2x(a.startS())}).attr("y",
0).attr("width",function(a){return m.sec2width(a.durS())}).attr("height",w).style("fill",J);a=w-z.silLv*w/100;f.labelsLayer.append("line").attr("id","sil-lv").attr("class","sil-lv").attr("x1",0).attr("y1",a).attr("x2",y).attr("y2",a)}else a=O(z.labels),f.labelsRects=f.labelsLayer.selectAll("rect").data(a),f.labelsRects.enter().append("rect").call(N).attr("class","label").attr("x",function(a){return m.sec2x(a.startS())}).attr("y",0).attr("width",function(a){return m.sec2width(a.durS())}).attr("height",
w).on("click",r).on("mouseover",H).on("mouseout",C).style("fill",J)}function q(){for(var a=d3.scale.linear().range([0,y]).domain([0,z.len]),b=d3.scale.linear().range([K,0]).domain([0,Math.max.apply(null,z.vol)]),c=d3.svg.area().x(function(a,b){return b}).y0(K).y1(function(a){return b(a)}),d=[],e=0;e<y;e++)d.push(z.vol[Math.floor(a.invert(e))]);f.contextVolume.datum(d).attr("d",c);a=d3.scale.linear().range([0,y]).domain([0,z.durS]);a=d3.svg.axis().scale(a).orient("bottom");f.contextAxis.call(a);t();
f.brush.style("visibility","visible")}function p(a){var b=m.sec2x(z.curS);f.currentPos.attr("x1",b).attr("x2",b);a&&!m.isVisible(z.curS)&&m.startS(z.curS);z.isSearchMode||z.isPlaying||!z.labels||!z.labels.canInsertLabel(z.curS,z.INSERT_DUR_S,z.durS)?f.insertHandleLayer.style("visibility","hidden"):(f.insertHandleLayer.style("visibility","visible"),a=m.sec2x(z.curS),u(f.insertHandle,[a,0],[a,0]),u(f.insertIcon,[a,0],[a,0]))}function t(){var a=m.sec2ax(m.startS()),b=m.sec2ax(m.durS());0===b&&(b=1);
f.brush.attr("x",a).attr("width",b)}function r(){if(!z.isPlaying&&!z.isAudioPlaying){var a=d3.mouse(this)[0],a=m.x2sec(a);z.curS=a;p();z.toolbar.setEnable();f.activeLabel&&I()}}function G(){var a=d3.mouse(this)[0],b=m.width2sec(y/2),a=m.ax2sec(a)-b;m.startS(a)}function H(a){if(!(z.isSearchMode||D||z.isPlaying||f.activeLabel&&L(a,d3.mouse(this)))){f.activeLabelLayer.style("visibility","visible");f.activeLabel=d3.select(this).classed("active",!0);var b=m.sec2x(a.startS()),c=m.sec2width(a.durS()),d=
a.durS()*z.factor+z.addS,d=m.sec2width(d),e=y,g=z.labels.getNext(a);g&&(e=m.sec2x(g.endS()));var g=0,h=z.labels.getPrev(a);h&&(g=m.sec2x(h.endS()));a.dragInfo={x:b,w:c,pauseW:d,leftX:b,rightX:b+c,rightMinX:g,rightMaxX:e};x(f.leftHandleLayer.call(W));e=2*P;u(f.leftHandle,[b,e],[b,0]);u(f.leftHandleTriangle,[b,e],[b,0]);e=b+c;x(f.rightHandleLayer.call(X));g=4*P;u(f.rightHandle,[e,g],[e,0]);u(f.rightHandleTriangle,[e,g],[e,0]);e=b+c/2;x(f.removeHandleLayer);u(f.removeHandle,[e,w],[e-50,0]);u(f.removeIcon,
[e,w],[e,0]);z.labels.canLeftMerge(a)&&(x(f.lmergeHandleLayer),u(f.lmergeHandle,[b,w],[b+65,0]),u(f.lmergeIcon,[b,w],[b,0]));z.labels.canRightMerge(a)&&(e=b+c,x(f.rmergeHandleLayer),u(f.rmergeHandle,[e,w],[e-65,0]),u(f.rmergeIcon,[e,w],[e-65,0]));a.contains(z.curS)&&I();x(f.play1HandleLayer);u(f.play1Handle,[b,0],[b,0]);u(f.play1Icon,[b,0],[b,0]);a=b+c;x(f.play3HandleLayer);u(f.play3Handle,[a,0],[a-65,0]);u(f.play3Icon,[a,0],[a-65,0]);b+=c;f.pauseRect.interrupt().attr("x",b).attr("width",0).transition().duration(Q).attr("width",
d)}}function I(){if(z.isSearchMode||z.isPlaying||!f.activeLabel||!z.labels.canCut(z.curS))f.cutHandleLayer.style("visibility","hidden");else{x(f.cutHandleLayer);x(f.play2HandleLayer);var a=m.sec2x(z.curS);u(f.cutHandle,[a,0],[a,0]);u(f.cutIcon,[a,0],[a,0]);u(f.play2Handle,[a,0],[a-65,0]);u(f.play2Icon,[a,0],[a-65,0])}}function x(a){a.data(f.activeLabel.data()).style("visibility","visible")}function u(a,b,c){b=v(b[0],b[1])+" scale(0)";c=v(c[0],c[1]);f.activeLabel&&a.data(f.activeLabel.data());a.interrupt().attr("transform",
b).transition().duration(Q).attr("transform",c)}function A(){d3.select(this).classed("hover",!0)}function B(){d3.select(this).classed("hover",!1)}function C(a){D||L(a,d3.mouse(this))||(E(),a.dragInfo=void 0)}function E(){f.activeLabel&&(f.activeLabelLayer.style("visibility","hidden"),f.activeLabelLayer.selectAll(".handle-layer").style("visibility","hidden"),f.activeLabel.classed("active",!1),f.activeLabel=null)}function L(a,b){var c=b[0],d=b[1],e=m.sec2x(a.startS()),f=m.sec2width(a.durS());return e+
4<=c&&c<e+f-4&&4<=d&&d<w-4?!0:!1}function R(){return m.canZoomIn()}function S(){m.zoomIn();z.toolbar.setEnable()}function T(){return m.canZoomOut()}function U(){m.zoomOut();z.toolbar.setEnable()}function O(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];m.isVisible(d.startS(),d.endS())&&b.push(d)}return b}function V(){var a=Math.max(-1,Math.min(1,d3.event.wheelDelta||-d3.event.detail)),b=d3.mouse(this)[0],c=m.x2sec(b);0>a?T()&&U(c):R()&&S(c);a=c-m.width2sec(b);m.startS(a);d3.event.preventDefault()}
function J(a){a=a.colour();return["rgb(",a[0],",",a[1],",",a[2],")"].join("")}function v(a,b){return["translate(",a,",",b,")"].join("")}z.viz={init:function(){f={};d3.select("#viz").on("mousewheel",V);d3.select("#viz").on("DOMMouseScroll",V);d3.select("#focus-layer").attr("transform",v(F.left,F.top));f.focusVolume=d3.select("#focus-volume");f.focusAxis=d3.select("#focus-axis").attr("transform",v(0,w));d3.select("#context-layer").attr("transform",v(M.left,M.top));f.contextVolume=d3.select("#context-volume");
f.contextAxis=d3.select("#context-axis").attr("transform",v(0,K));d3.select("#focus-rect").call(N).attr("width",y).attr("height",w).on("click",r);d3.select("#context-rect").attr("width",y).attr("height",K).on("click",G);f.labelsLayer=d3.select("#labels-layer");f.activeLabelLayer=d3.select("#active-label-layer");h();f.leftHandleLayer=d3.select("#left-handle-layer").on("mouseout",C);f.leftHandle=d3.select("#left-handle").on("mouseover",A).on("mouseout",B);f.leftHandleTriangle=d3.select("#left-handle-triangle");
f.rightHandleLayer=d3.select("#right-handle-layer").on("mouseout",C);f.rightHandle=d3.select("#right-handle").on("mouseover",A).on("mouseout",B);f.rightHandleTriangle=d3.select("#right-handle-triangle");e();d();c();b();a();g();l();f.pauseRect=d3.select("#pause-rect");f.currentPos=d3.select("#current-pos");f.brush=d3.select("#brush")},setVolume:function(){m.maxEndS(z.durS);n();q()},updateLabels:k,updateCurrentPos:p,canZoomIn:R,zoomIn:S,canZoomOut:T,zoomOut:U};var F={top:10,right:10,bottom:100,left:10},
M={top:430,right:10,bottom:20,left:10},y=960-F.left-F.right,w=500-F.top-F.bottom,K=500-M.top-M.bottom,Q=500,P=Math.floor(w/6),m=z.viewport(y,z.VOL_RATE,function(){n();k();p();t();f.activeLabel&&E()}),D=!1,f;z.viz.F_HEIGHT=w;var N=d3.behavior.drag().on("dragstart",function(){D=!0}).on("dragend",function(){D=!1}).on("drag",function(){m.startS(m.startS()-m.width2sec(d3.event.dx))}),W=d3.behavior.drag().on("dragstart",function(){D=!0}).on("dragend",function(a){D=!1;z.history.save(z.labels);z.toolbar.setEnable();
f.activeLabel&&!L(a,d3.mouse(this))&&E()}).on("drag",function(a){if(!(m.width2sec(a.dragInfo.w-d3.event.dx)<=z.MIN_DUR_S)){a.dragInfo.leftX+=d3.event.dx;a.dragInfo.x+=d3.event.dx;a.dragInfo.w-=d3.event.dx;var b=a.dragInfo.leftX,c=a.dragInfo.x,d=a.dragInfo.w;f.leftHandle.attr("transform",v(b,0));f.leftHandleTriangle.attr("transform",v(b,0));f.lmergeHandle.attr("transform",v(b+65,0));f.lmergeIcon.attr("transform",v(b,0));f.removeHandle.attr("transform",v(c+d/2-50,0));f.removeIcon.attr("transform",v(c+
d/2,0));f.play1Handle.attr("transform",v(b,0));f.play1Icon.attr("transform",v(b,0));a.startS(m.x2sec(c));f.activeLabel.attr("x",c).attr("width",d).style("fill",J);b=z.calcPauseS(a.durS());a.dragInfo.pauseW=m.sec2width(b);f.pauseRect.attr("width",a.dragInfo.pauseW)}}),X=d3.behavior.drag().on("dragstart",function(){D=!0}).on("dragend",function(a){D=!1;z.history.save(z.labels);z.toolbar.setEnable();f.activeLabel&&!L(a,d3.mouse(this))&&E()}).on("drag",function(a){if(!(m.width2sec(a.dragInfo.w+d3.event.dx)<=
z.MIN_DUR_S)){var b=a.dragInfo.rightX+d3.event.dx;if(!(b<=a.dragInfo.rightMinX||b>=a.dragInfo.rightMaxX)){a.dragInfo.rightX+=d3.event.dx;a.dragInfo.w+=d3.event.dx;var c=a.dragInfo.rightX,b=a.dragInfo.x,d=a.dragInfo.w;f.rightHandle.attr("transform",v(c,0));f.rightHandleTriangle.attr("transform",v(c,0));f.play3Handle.attr("transform",v(c-65,0));f.play3Icon.attr("transform",v(c-65,0));f.rmergeHandle.attr("transform",v(c-65,0));f.rmergeIcon.attr("transform",v(c-65,0));f.removeHandle.attr("transform",
v(b+d/2-50,0));f.removeIcon.attr("transform",v(b+d/2,0));a.endS(m.x2sec(b+d));f.activeLabel.attr("width",d).style("fill",J);c=z.calcPauseS(a.durS());a.dragInfo.pauseW=m.sec2width(c);f.pauseRect.attr("x",b+d).attr("width",a.dragInfo.pauseW)}}})})();(function(){function h(){var a=d3.select("#sil-lv-text");d3.select("#sil-lv").on("input",function(){z.silLv=parseInt(this.value);a.text(z.silLv);var b=z.viz.F_HEIGHT-z.silLv*z.viz.F_HEIGHT/100;d3.select("#sil-lv").attr("y1",b).attr("y2",b)}).on("change",function(){z.labelsSearch=null;z.viz.updateLabels()})}function e(){var a=d3.select("#sil-dur-text");d3.select("#sil-dur").on("input",function(){z.silDurS=parseInt(this.value)/100;a.text(z.silDurS.toFixed(2))}).on("change",function(){z.labelsSearch=
null;z.viz.updateLabels()})}function d(){var a=d3.select("#snd-dur-text");d3.select("#snd-dur").on("input",function(){z.sndDurS=parseInt(this.value)/100;a.text(z.sndDurS.toFixed(2))}).on("change",function(){z.labelsSearch=null;z.viz.updateLabels()})}function c(){var a=d3.select("#before-dur-text");d3.select("#before-dur").on("input",function(){z.beforeDurS=parseInt(this.value)/100;a.text(z.beforeDurS.toFixed(2))}).on("change",function(){z.labelsSearch=null;z.viz.updateLabels()})}function b(){var a=
d3.select("#after-dur-text");d3.select("#after-dur").on("input",function(){z.afterDurS=parseInt(this.value)/100;a.text(z.afterDurS.toFixed(2))}).on("change",function(){z.labelsSearch=null;z.viz.updateLabels()})}z.initSearchPanel=function(){h();e();d();c();b()};z.okSearch=function(){z.setDivVisibility("#search-mode-tab",!1);z.setDivVisibility("#normal-mode-tab",!0);z.labels=z.labelsSearch;z.history.save(z.labels);z.labelsSearch=null;z.isSearchMode=!1;z.viz.updateLabels();z.toolbar.setEnable()};z.cancelSearch=
function(){z.setDivVisibility("#search-mode-tab",!1);z.setDivVisibility("#normal-mode-tab",!0);z.labelsSearch=null;z.isSearchMode=!1;z.viz.updateLabels()}})();(function(){z.toolbar={init:function(){for(var e=0;e<h.length;e++){var d=h[e];d.item=d3.select(d.id);if(d.onClick)d.item.on("click",function(c){return function(){c.item.classed("enabled")&&(c.onClick(),z.toolbar.setEnable())}}(d))}},setEnable:function(){for(var e=0;e<h.length;e++){var d=h[e];z.vol&&d.isEnable&&d.isEnable()?d.item.classed("enabled",!0):d.item.classed("enabled",!1)}}};var h=[{id:"#tool-head",isEnable:z.canHead,onClick:z.head},{id:"#tool-play",isEnable:z.player.canPlay,onClick:z.player.play},
{id:"#tool-playpause",isEnable:z.player.canPlay,onClick:z.player.playPause},{id:"#tool-pause",isEnable:z.player.canPause,onClick:z.player.pause},{id:"#tool-zoomin",isEnable:z.viz.canZoomIn,onClick:z.viz.zoomIn},{id:"#tool-zoomout",isEnable:z.viz.canZoomOut,onClick:z.viz.zoomOut},{id:"#tool-undo",isEnable:z.canUndo,onClick:z.undo},{id:"#tool-redo",isEnable:z.canRedo,onClick:z.redo}]})();
