(function(){function c(){d3.select("#volume").on("input",function(){z.player.changeVolume(this)}).on("change",function(){z.player.changeVolume(this)})}function b(){d3.select("body").on("keydown",function(){var a=d3.event.keyCode;107===a?z.viz.zoomIn():109===a&&z.viz.zoomOut()})}function a(a){z.buffer=a;z.vol=z.calcVolume(a);z.len=z.vol.length;z.durS=a.duration;z.curS=0;z.offsetTime=0;z.viz.setCurrentPos(0);z.viz.setVolume();z.labels=z.findSound(z.vol);z.viz.setLabels()}function e(){z.isAudioPlaying&&
(z.curS=z.offsetTime+z.context.currentTime-z.startTime);z.viz.setCurrentPos(z.curS)}window.z={WIDTH:960,HEIGHT:500,run:function(){z.context=z.audio.getContext();z.context?(z.file.init(),z.viz.init(),z.toolbar.init(),z.player.onChange=e,c(),b(),z.toolbar.setEnable(),z.audio.load(z.context,"jfk.mp3",a)):window.alert("Your browser is not supported")},head:function(){z.isPlaying&&z.player.pause();z.curS=0;z.offsetTime=0;z.viz.setCurrentPos(0);z.toolbar.setEnable()},canHead:function(){return 0!==z.curS&&
!z.isPlaying&&!z.isAudioPlaying},onLoadAudio:a,context:null,source:null,isPlaying:!1,isAudioPlaying:!1,startTime:0,offsetTime:0,buffer:null,timerId:null,vol:[0],len:1,durS:0,curS:0,curGain:1,labels:[],curLabelI:0}})();(function(){function c(){b();var a=this.files||d3.event.dataTransfer.files;window.console.log(URL.createObjectURL(a[0]));z.audio.load(z.context,URL.createObjectURL(a[0]),z.onLoadAudio)}function b(){d3.event.stopPropagation();d3.event.preventDefault();e.className="dragover"===d3.event.type?"hover":""}window.z.file={init:function(){if(!(window.File&&window.FileList&&window.FileReader))return!1;a=d3.select("#file-select");e=d3.select("#viz");a.on("change",c);e.on("dragover",b);e.on("dragleave",b);e.on("drop",
c)}};var a,e})();(function(){window.z.audio={getContext:function(){var c=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,b=null;c&&(b=new c);return b},load:function(c,b,a){var e=new XMLHttpRequest;e.open("GET",b,!0);e.responseType="arraybuffer";e.onload=function(){c.decodeAudioData(e.response,function(b){a(b)},function(){window.alert("error")})};e.send()}}})();(function(){function c(b,a,e){for(var c=0,f=a;f<e;f++)c+=b[f]*b[f];return Math.sqrt(c/(e-a))}window.z.VOL_RATE=768;window.z.calcVolume=function(b){for(var a=b.getChannelData(0),e=b.sampleRate,r=Math.floor(b.length*z.VOL_RATE/e),f=[],h=0,p=0;p<r;p++){var u=Math.floor((p+1)*e/z.VOL_RATE),u=Math.min(u,b.length);f.push(c(a,h,u));h=u}return f};window.z.getSubVolume=function(b,a,e){b=Math.floor(b*z.VOL_RATE);a=Math.floor(a*z.VOL_RATE);var c;if(1===e)c=z.vol.slice(b,a);else for(c=[];b<a;b+=e)c.push(z.vol[b]);
return c}})();(function(){function c(b,a,c){this.colour=null;this.initPos(b,a);this.type=c===z.LBL_CUT?z.LBL_CUT:z.LBL_PAUSE}window.z.Label=c;window.z.LBL_PAUSE="p";window.z.LBL_CUT="x";c.prototype.isPause=function(){return this.type===z.LBL_PAUSE};c.prototype.isCut=function(){return this.type===z.LBL_CUT};c.prototype.setPause=function(){this.type=z.LBL_PAUSE};c.prototype.setCut=function(){this.type=z.LBL_CUT};c.prototype.contains=function(b){return this.startS<=b&&b<=this.endS?!0:!1};c.prototype.shift=function(b){this.startS+=
b;this.endS+=b;this.colour=null};c.prototype.setStartS=function(b){this.startS=Math.max(0,Math.min(b,this.endS-.1));this.colour=null};c.prototype.setEndS=function(b){this.endS=Math.max(this.startS+.1,b);this.colour=null};c.prototype.getDurS=function(){return this.endS-this.startS};c.prototype.getColour=function(){if(!this.colour){var b=60*this.getDurS()+380;if(780<b)this.colour=[255,0,0];else{var a=Math.floor(b),c,r;380<=a&&440>a?(b=-(a-440)/90,c=0,r=1):440<=a&&490>a?(b=0,c=(a-440)/50,r=1):490<=a&&
510>a?(b=0,c=1,r=-(a-510)/20):(510<=a&&580>a?(b=(a-510)/70,c=1):580<=a&&645>a?(b=1,c=-(a-645)/65):(b=645<=a&&780>=a?1:0,c=0),r=0);a=255*(380<=a&&420>a?.3+.7*(a-350)/70:420<=a&&700>=a?1:700<a&&780>=a?.3+.7*(780-a)/80:0);this.colour=[Math.floor(a*b),Math.floor(a*c),Math.floor(a*r)]}}return this.colour};c.prototype.initPos=function(b,a){a=Math.max(0,a);this.startS=b=Math.max(0,Math.min(b,a));this.endS=a}})();(function(){window.z.findSound=function(f,h,p,u,n){h="undefined"!==typeof h?h:c;p="undefined"!==typeof p?p:b;u="undefined"!==typeof u?u:e;n="undefined"!==typeof n?n:r;var m=f.length/z.VOL_RATE;h=Math.max(0,Math.min(h,100));var q=Math.max.apply(null,f);h=h*q/100;var t=p*z.VOL_RATE;p=a*z.VOL_RATE;for(var k=0,l=0,g=-1,q=-1,v=!0,d=[],w=0;w<f.length;w++)if(f[w]<=h)if(k++,-1===g)g=w;else{if(!v&&-1!==q&&k>t&&l>p){t=g+Math.floor(n*z.VOL_RATE);f.length<t&&(t=f.length);k=0;for(l=g;l<t;l++)if(f[l]<=h)k++;else break;
t=k;k=q/z.VOL_RATE-u;k=Math.max(0,Math.min(k,m));g=(g+t)/z.VOL_RATE;g=Math.max(0,Math.min(g,m));d.push(new z.Label(k,g,z.LBL_PAUSE));v=!0;l=k=0;g=-1}}else l++,v&&(v=!1,q=w),k=0,g=-1;v||(k=q/z.VOL_RATE-u,k=Math.max(0,Math.min(k,m)),g=g/z.VOL_RATE+n,g=Math.max(0,Math.min(g,m)),g<k&&(g=m),d.push(new z.Label(k,g,z.LBL_PAUSE)));return d};var c=5,b=.3,a=.2,e=.2,r=.2})();(function(){function c(){return!z.isPlaying&&!z.isAudioPlaying}function b(b){h>=f.length&&(h=0,z.curS=0);z.isPlaying=!0;var c=f[h],m=c.offset,q=c.dur;b&&c.type===e&&z.curS!==c.offset&&(m=z.curS,q-=z.curS-c.offset);z.offsetTime=m;c.type===e?(b=m,z.source=z.context.createBufferSource(),z.source.buffer=z.buffer,z.source.onended=a,z.gainNode=z.context.createGain(),z.gainNode.gain.value=z.curGain,z.source.connect(z.gainNode),z.gainNode.connect(z.context.destination),z.source.start(0,b,q),z.startTime=z.context.currentTime,
z.isAudioPlaying=!0,p=setInterval(z.player.onChange,20)):setTimeout(a,Math.floor(1E3*q))}function a(){h++;z.gainNode=null;z.player.onChange();z.isAudioPlaying&&(z.isAudioPlaying=!1,clearInterval(p));z.isPlaying&&b()}window.z.player={canPlay:c,play:function(){c()&&(f=[{type:e,offset:0,dur:z.durS}],h=0,b(!0))},playPause:function(){if(c()){f=[];for(var a=h=0,n=0;n<z.labels.length;n++){var m=z.labels[n];m.isPause()&&(f.push({type:e,offset:a,dur:m.endS-a}),a=m.endS,f.push({type:r,offset:a,dur:m.getDurS()}))}a:for(a=
0;a<f.length;a++)if(n=f[a],n.type===e&&n.offset<=z.curS&&z.curS<n.offset+n.dur){h=a;break a}b(!0)}},canPause:function(){return z.isPlaying||z.isAudioPlaying},pause:function(){z.isPlaying=!1;z.isAudioPlaying&&(z.isAudioPlaying=!1,clearInterval(p),z.source.stop(),z.curS=z.offsetTime+z.context.currentTime-z.startTime)},changeVolume:function(a){a=parseInt(a.value)/parseInt(a.max);z.curGain=a*a;z.gainNode&&(z.gainNode.gain.value=z.curGain)},onChange:null};var e=1,r=2,f=[],h,p})();(function(){function c(a){var b=a*z.VOL_RATE/d.scale;y.attr("x1",b).attr("x2",b);(a<d.startS||a>d.endS())&&r(a)}function b(a){a=a.getColour();return["rgb(",a[0],",",a[1],",",a[2],")"].join("")}function a(){var a=d3.scale.linear().range([g,0]).domain([0,Math.max.apply(null,z.vol)]),b=d3.svg.area().x(function(a,b){return b}).y0(g).y1(function(b){return a(b)}),c=d.endS(),c=z.getSubVolume(d.startS,c,d.scale);w.datum(c).attr("d",b);b=l*d.scale/z.VOL_RATE;b=d3.scale.linear().range([0,l]).domain([d.startS,
d.startS+b]);b=d3.svg.axis().scale(b).orient("bottom");B.call(b)}function e(){for(var a=d3.scale.linear().range([0,l]).domain([0,z.len]),b=d3.scale.linear().range([v,0]).domain([0,Math.max.apply(null,z.vol)]),c=d3.svg.area().x(function(a,b){return b}).y0(v).y1(function(a){return b(a)}),e=[],d=0;d<l;d++)e.push(z.vol[Math.floor(a.invert(d))]);C.datum(e).attr("d",c);a=d3.scale.linear().range([0,l]).domain([0,z.durS]);a=d3.svg.axis().scale(a).orient("bottom");D.call(a);f();A.style("visibility","visible")}
function r(b){b=Math.max(0,Math.min(b,z.durS-l*d.scale/z.VOL_RATE));b!==d.startS&&(d.startS=b,a(),f(),m(),q())}function f(){var a=d.startS*l/z.durS,b;b=d.durS()*l/z.durS;0===b&&(b=1);A.attr("x",a).attr("width",b)}function h(){if(!z.isPlaying&&!z.isAudioPlaying){var a=d.startS,a=a+d3.mouse(this)[0]*d.scale/z.VOL_RATE;z.curS=a;c(a);z.toolbar.setEnable()}}function p(){var a;a=d3.mouse(this)[0]*z.durS/l;a-=l*d.scale/2/z.VOL_RATE;r(a)}function u(){return 1!==d.scale}function n(){return 8>=d.scale}function m(){x.attr("transform",
["translate(",-d.startS*z.VOL_RATE/d.scale,",0) scale(",1/d.scale,",1)"].join(""))}function q(){y.attr("transform",["translate(",-d.startS*z.VOL_RATE/d.scale,",0)"].join(""))}window.z.viz={init:function(){d3.select("#focus-layer").attr("transform",["translate(",t.left,",",t.top,")"].join(""));w=d3.select("#focus-volume");B=d3.select("#focus-axis").attr("transform",["translate(0,",g,")"].join(""));d3.select("#context-layer").attr("transform",["translate(",k.left,",",k.top,")"].join(""));C=d3.select("#context-volume");
D=d3.select("#context-axis").attr("transform",["translate(0,",v,")"].join(""));d3.select("#focus-rect").attr("width",l).attr("height",g).on("click",h);d3.select("#context-rect").attr("width",l).attr("height",v).on("click",p);A=d3.select("#brush");x=d3.select("#labels-layer");y=d3.select("#current-pos")},setVolume:function(){e();a()},setLabels:function(){x.selectAll("rect").remove();E=x.selectAll("rect").data(z.labels);E.enter().append("rect").attr("class","label").attr("x",function(a){return a.startS*
z.VOL_RATE}).attr("y",0).attr("width",function(a){return a.getDurS()*z.VOL_RATE}).attr("height",g).style("fill",b);m()},setCurrentPos:c,canZoomIn:u,zoomIn:function(){u()&&(d.scale/=2,a(),f(),m(),q(),z.isPlaying&&c(z.curS))},canZoomOut:n,zoomOut:function(){n()&&(d.scale*=2,a(),f(),m(),q(),z.isPlaying&&c(z.curS))}};var t={top:10,right:10,bottom:100,left:10},k={top:430,right:10,bottom:20,left:10},l=960-t.left-t.right,g=500-t.top-t.bottom,v=500-k.top-k.bottom,d={startS:0,scale:4,endS:function(){return Math.min(this.startS+
l*this.scale/z.VOL_RATE,z.durS)},durS:function(){return this.endS()-this.startS}},w,B,C,D,A,x,E,y})();(function(){window.z.toolbar={init:function(){for(var b=0;b<c.length;b++){var a=c[b];a.item=d3.select(a.id);if(a.onClick)a.item.on("click",function(a){return function(){a.item.classed("enabled")&&(a.onClick(),z.toolbar.setEnable())}}(a))}},setEnable:function(){for(var b=0;b<c.length;b++){var a=c[b];a.isEnable&&a.isEnable()?a.item.classed("enabled",!0):a.item.classed("enabled",!1)}}};var c=[{id:"#tool-head",isEnable:z.canHead,onClick:z.head},{id:"#tool-play",isEnable:z.player.canPlay,onClick:z.player.play},
{id:"#tool-playpause",isEnable:z.player.canPlay,onClick:z.player.playPause},{id:"#tool-pause",isEnable:z.player.canPause,onClick:z.player.pause},{id:"#tool-zoomin",isEnable:z.viz.canZoomIn,onClick:z.viz.zoomIn},{id:"#tool-zoomout",isEnable:z.viz.canZoomOut,onClick:z.viz.zoomOut}]})();
